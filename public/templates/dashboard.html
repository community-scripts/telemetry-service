<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Proxmox VE Helper-Scripts</title>
    <meta name="description" content="Installation analytics and telemetry for Proxmox VE Helper Scripts">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/svg-inliner.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="https://community-scripts.github.io/ProxmoxVE/" class="navbar-brand" target="_blank">
            <img width="28" src="/static/img/logo.png" alt="">
            Proxmox VE Helper-Scripts
        </a>
        
        <div class="navbar-center">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span id="loadingIndicator" style="display: none; color: var(--accent-cyan); font-size: 14px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; margin-right: 6px;">
                        <circle cx="12" cy="12" r="10" stroke-opacity="0.3"/>
                        <path d="M12 2a10 10 0 0 1 10 10"/>
                    </svg>
                    Loading data...
                </span>
                <span id="cacheStatus" style="font-size: 12px; color: var(--text-muted);"></span>
            </div>
        </div>
        
        <div class="navbar-actions">
            <a href="/error-analysis" class="nav-icon" title="Error Analysis" style="font-size:14px;text-decoration:none;">üîç Errors</a>
            <a href="/script-analysis" class="nav-icon" title="Script Analysis" style="font-size:14px;text-decoration:none;">üìú Scripts</a>
            <a href="https://github.com/community-scripts/ProxmoxVE" target="_blank" class="github-stars" id="githubStars">
                <img src="/static/img/star.svg" alt="">
                <span id="starCount">-</span>
            </a>
            <a href="https://github.com/community-scripts/ProxmoxVE" target="_blank" class="nav-icon" title="GitHub">
                <img src="/static/img/github.svg">
            </a>
            <a href="https://discord.gg/2wvnMDgeFz" target="_blank" class="nav-icon" title="Discord">
                <img src="/static/img/discord.svg">
            </a>
            <button class="theme-toggle nav-icon" onclick="toggleTheme()" title="Toggle theme">
                <span id="themeIcon">üåô</span>
            </button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1>Analytics</h1>
            <p>Overview of container installations and system statistics.</p>
        </div>
        
        <!-- Filters Bar -->
        <div class="filters-bar" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 24px;">
            <div class="filter-group">
                <label>Source:</label>
                <div class="quickfilter">
                    <button class="source-btn active" data-repo="ProxmoxVE">ProxmoxVE</button>
                    <button class="source-btn" data-repo="ProxmoxVED">ProxmoxVED</button>
                    <button class="source-btn" data-repo="external">External</button>
                    <button class="source-btn" data-repo="all">All</button>
                </div>
            </div>
            <div class="filter-divider"></div>
            <div class="filter-group">
                <label>Period:</label>
                <div class="quickfilter">
                    <button class="filter-btn active" data-days="1">Today</button>
                    <button class="filter-btn" data-days="7">7 Days</button>
                    <button class="filter-btn" data-days="30">30 Days</button>
                    <button class="filter-btn" data-days="90">90 Days</button>
                    <button class="filter-btn" data-days="365">1 Year</button>
                </div>
            </div>
            <div class="filter-divider"></div>
            <div class="auto-refresh-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                    <span class="toggle-slider"></span>
                </label>
                <span>Auto-refresh</span>
                <span class="auto-refresh-interval" id="refreshInterval">15s</span>
            </div>
            <div style="margin-left: auto; display: flex; gap: 8px;">
                <button class="btn" onclick="refreshData()">
                    <img src="/static/img/refresh.svg" alt="">
                    Refresh
                </button>
                <span class="last-updated" id="lastUpdated" style="align-self: center; font-size: 12px; color: var(--text-muted);"></span>
            </div>
        </div>
        
        <!-- Error Banner -->
        <div id="error" class="error-banner" style="display: none;">
            <img src="/static/img/clock.svg" alt="">
            <span id="errorText"></span>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-label">Total Created</span>
                    <div class="stat-card-icon">
                        <img src="/static/img/list.svg" alt="">
                    </div>
                </div>
                <div class="stat-card-value" id="totalInstalls">-</div>
                <div class="stat-card-subtitle">Total LXC/VM entries found</div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-card-header">
                    <span class="stat-card-label">Success Rate</span>
                    <div class="stat-card-icon">
                        <img src="/static/img/success.svg" alt="">
                    </div>
                </div>
                <div class="stat-card-value" id="successRate">-</div>
                <div class="stat-card-subtitle" id="successSubtitle">successful installations</div>
            </div>
            
            <div class="stat-card failed">
                <div class="stat-card-header">
                    <span class="stat-card-label">Failed</span>
                    <div class="stat-card-icon">
                        <img src="/static/img/fail.svg" alt="">
                    </div>
                </div>
                <div class="stat-card-value" id="failedCount">-</div>
                <div class="stat-card-subtitle" id="failedSubtitle">installation failures</div>
            </div>
            
            <div class="stat-card aborted">
                <div class="stat-card-header">
                    <span class="stat-card-label">Aborted</span>
                    <div class="stat-card-icon">
                        <img src="/static/img/clock.svg" alt="">
                    </div>
                </div>
                <div class="stat-card-value" id="abortedCount">-</div>
                <div class="stat-card-subtitle">user cancelled (Ctrl+C)</div>
            </div>
            
            <!-- Most Popular Card -->
            <div class="stat-card podium-card">
                <div class="stat-card-header">
                    <span class="stat-card-label">Most Popular</span>
                    <div class="stat-card-icon" style="font-size: 20px;">üèÜ</div>
                </div>
                <div class="mini-podium">
                    <div class="mini-podium-item gold">
                        <span class="medal">ü•á</span>
                        <span class="app-name" id="podium1App">-</span>
                        <span class="count" id="podium1Count">-</span>
                    </div>
                    <div class="mini-podium-item silver">
                        <span class="medal">ü•à</span>
                        <span class="app-name" id="podium2App">-</span>
                        <span class="count" id="podium2Count">-</span>
                    </div>
                    <div class="mini-podium-item bronze">
                        <span class="medal">ü•â</span>
                        <span class="app-name" id="podium3App">-</span>
                        <span class="count" id="podium3Count">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Applications Section -->
        <div class="section-card">
            <div class="section-header">
                <div>
                    <h2>Top Applications</h2>
                    <p>The most frequently installed applications.</p>
                </div>
                <div class="section-actions">
                    <button class="btn" id="viewAllAppsBtn" onclick="toggleAllApps()">
                        <img src="/static/img/list2.svg" alt="">
                        View All
                    </button>
                </div>
            </div>
            <div class="chart-container" id="appsChartContainer">
                <canvas id="appsChart"></canvas>
            </div>
        </div>
        
        <!-- Secondary Charts -->
        <div class="section-card" style="margin-bottom: 24px;">
            <div class="section-header">
                <div>
                    <h2>Installations Over Time</h2>
                    <p>Daily success and failure trends.</p>
                </div>
            </div>
            <div style="padding: 24px; height: 320px;">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
            <div class="chart-card">
                <h3>OS Distribution</h3>
                <div class="chart-wrapper" style="height: 260px;">
                    <canvas id="osChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Status Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Error Analysis Section (combined) -->
        <div class="section-card">
            <div class="section-header">
                <div>
                    <h2>Error Analysis</h2>
                    <p>Error patterns, failure rates, and applications that need attention. <span id="failedAppsThreshold" style="color: var(--text-muted); font-size: 12px;"></span></p>
                </div>
                <div class="section-actions">
                    <a href="/error-analysis" class="btn" style="text-decoration:none;">
                        <img src="/static/img/search.svg" alt="">
                        Deep Analysis
                    </a>
                </div>
            </div>
            <div class="error-analysis-grid">
                <div class="error-analysis-col">
                    <h3 class="error-analysis-subtitle">
                        <img src="/static/img/fail2.svg" alt="">
                        Common Error Patterns
                    </h3>
                    <div class="error-list" id="errorList">
                        <div class="loading"><div class="loading-spinner"></div>Loading...</div>
                    </div>
                </div>
                <div class="error-analysis-col">
                    <h3 class="error-analysis-subtitle">
                        <img src="/static/img/heartbeat.svg" alt="">
                        Highest Failure Rates
                    </h3>
                    <div class="failed-apps-grid" id="failedAppsGrid">
                        <div class="loading"><div class="loading-spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Installation Log Section -->
        <div class="section-card">
            <div class="section-header">
                <div>
                    <h2>Installation Log</h2>
                    <p>Detailed records of all container creation attempts.</p>
                </div>
                <div class="section-actions">
                    <button class="btn" onclick="exportCSV()">
                        <img src="/static/img/download.svg" alt="">
                        Export CSV
                    </button>
                </div>
            </div>
            <div class="filters-bar">
                <input type="text" class="search-input" id="filterApp" placeholder="Filter by application..." oninput="filterTable()">
                <select id="filterStatus" class="custom-select" onchange="filterTable()">
                    <option value="">All Status</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                    <option value="aborted">Aborted</option>
                    <option value="installing">Installing</option>
                    <option value="configuring">Configuring</option>
                    <option value="unknown">Unknown</option>
                </select>
                <select id="filterOs" class="custom-select" onchange="filterTable()">
                    <option value="">All OS</option>
                </select>
                <select id="filterType" class="custom-select" onchange="filterTable()">
                    <option value="">All Types</option>
                    <option value="lxc">LXC</option>
                    <option value="vm">VM</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table id="installTable">
                    <thead>
                        <tr>
                            <th data-sort="status" class="sortable">Status</th>
                            <th data-sort="type" class="sortable">Type</th>
                            <th data-sort="nsapp" class="sortable">Application</th>
                            <th data-sort="os_type" class="sortable">OS</th>
                            <th>Disk Size</th>
                            <th>Core Count</th>
                            <th>RAM Size</th>
                            <th data-sort="created" class="sortable sort-desc">Created At</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable">
                        <tr><td colspan="8"><div class="loading"><div class="loading-spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-footer">
                <div class="per-page-select">
                    <label>Show:</label>
                    <select id="perPageSelect" class="custom-select" onchange="changePerPage()">
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="pagination">
                    <button onclick="prevPage()" id="prevBtn" disabled>Previous</button>
                    <span class="pagination-info" id="pageInfo">Page 1</span>
                    <button onclick="nextPage()" id="nextBtn">Next</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Health Check Modal -->
    <div class="modal-overlay" id="healthModal" onclick="closeHealthModal(event)">
        <div class="modal-content health-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Health Check</h2>
                <button class="modal-close" onclick="closeHealthModal()">&times;</button>
            </div>
            <div class="modal-body" id="healthModalBody">
                <div class="loading"><div class="loading-spinner"></div>Checking...</div>
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal" onclick="closeModalOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">
                    <img src="/static/img/list.svg" alt="">
                    <span>Record Details</span>
                </h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content filled by JavaScript -->
            </div>
        </div>
    </div>
    <script src="/static/js/dashboard.js"></script>
</body>
</html>
